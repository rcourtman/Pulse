services:
  traefik:
    image: ${TRAEFIK_IMAGE:?TRAEFIK_IMAGE must be set to a digest-pinned image}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik-dynamic.yml:/etc/traefik/traefik-dynamic.yml:ro
      - acme-data:/etc/traefik/acme
    env_file:
      - .env
    environment:
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
      # Avoid relying on YAML interpolation support; force ACME email via env override.
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL=${ACME_EMAIL}
      - TRAEFIK_CERTIFICATESRESOLVERS_LE_ACME_EMAIL=${ACME_EMAIL}
    networks:
      - pulse-cloud
    restart: unless-stopped

  control-plane:
    image: ${CONTROL_PLANE_IMAGE:?CONTROL_PLANE_IMAGE must be set to a digest-pinned image}
    # - Or build locally from this repo:
    # build:
    #   context: ../../
    #   dockerfile: deploy/cloud/Dockerfile.control-plane
    volumes:
      - /data:/data
      # Control plane manages tenant containers via the host Docker daemon.
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - .env
    environment:
      - CP_DATA_DIR=/data
      - CP_ENV=${CP_ENV}
      - CP_BIND_ADDRESS=0.0.0.0
      - CP_PORT=8443
      - CP_ADMIN_KEY=${CP_ADMIN_KEY}
      - CP_BASE_URL=https://${DOMAIN}
      - CP_PULSE_IMAGE=${CP_PULSE_IMAGE}
      - CP_DOCKER_NETWORK=pulse-cloud
      - CP_TENANT_MEMORY_LIMIT=${CP_TENANT_MEMORY_LIMIT:-536870912}
      - CP_ALLOW_DOCKERLESS_PROVISIONING=${CP_ALLOW_DOCKERLESS_PROVISIONING:-false}
      - CP_REQUIRE_EMAIL_PROVIDER=${CP_REQUIRE_EMAIL_PROVIDER:-true}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - STRIPE_API_KEY=${STRIPE_API_KEY}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - PULSE_EMAIL_FROM=${PULSE_EMAIL_FROM}
    networks:
      - pulse-cloud
    depends_on:
      - traefik
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=pulse-cloud
      - traefik.http.routers.control-plane.rule=Host(`${DOMAIN}`)
      - traefik.http.routers.control-plane.entrypoints=websecure
      - traefik.http.routers.control-plane.tls=true
      - traefik.http.routers.control-plane.tls.certresolver=letsencrypt
      # Request wildcard cert for tenant subdomains (e.g. t-xyz.${DOMAIN}).
      - traefik.http.routers.control-plane.tls.domains[0].main=${DOMAIN}
      - traefik.http.routers.control-plane.tls.domains[0].sans=*.${DOMAIN}
      - traefik.http.services.control-plane.loadbalancer.server.port=8443

networks:
  pulse-cloud:
    external: true
    name: pulse-cloud

volumes:
  acme-data:
